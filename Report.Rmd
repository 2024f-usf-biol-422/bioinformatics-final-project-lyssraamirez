---
title: 'Analyzing SARS-CoV-2 in Pennsylvania Wastewater Samples: SNP Distribution, Temporal Trends, and Correlation with Population'
author: "Alyssa Ramirez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
csl: bioinformatics.csl
bibliography: references.bib
params:
  gff_file_path: "data/metadata/sars_refgenome_annotation.gff"
  vcf_dir_path: "data/11_vcf_output_for_R"
  sra_runtable_path: "data/00_sra_runtable/SraRunTable.csv"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE)
```

# Background and Overview

The primary objective of this analysis was to explore SARS-CoV-2 prevalence in Pennsylvania wastewater samples. This project focused on understanding the distribution of single nucleotide polymorphisms (SNPs) within the viral genome and how they vary across populations, sampling techniques, and temporal trends. Using public available sequencing data and associated metadata 

To what extent do sampling methods, collection periods, and population size affect SARS-CoV-2 RNA detection in wastewater?

To address this question, we employed a bioinformatics workflow that integrated raw VCF files, GFF annotations, and population metadata. The analyses were performed using custom R scripts, including functions provided by the instructor, and the outputs were used to generate informative figures and tables. The results demonstrated clear spatial and temporal patterns in SARS-CoV-2 prevalence and identified genes with significant SNP counts.



# Methods
Custom R functions provided by the instructor were used for key data processing steps:

1.read_gff: Read and parsed the GFF genome annotation file to extract genomic regions of interest.
2.extract_genes_from_gff: Filtered and cleaned the GFF data to produce a gene table containing genomic coordinates and gene names.
3.parse_tidy_and_stack_vcfs: Processed and combined multiple VCF files into a single tidy dataset, adding sample-specific metadata.
4.add_genes_metadata_to_vcfstack: Annotated SNPs with gene information by merging the tidy VCF data with the cleaned gene table and sequencing metadata.

See the set of tutorials on the [vcfR package website](https://knausb.github.io/vcfR_documentation/index.html).

You may also want to use any of a range of different COVID data packages and data sources:

* https://kjhealy.github.io/covdata/
* https://github.com/como-ph/oxcovid19
* https://ropensci.org/blog/2020/10/20/searching-medrxivr-and-biorxiv-preprint-data/
* https://covidtracking.com/data/api
  * `readr::read_csv("https://api.covidtracking.com/v1/states/daily.csv")`

## Subsections are ok too

# Results and Discussion
In this study, 

```{r load-packages-and-functions}
library("vcfR")
library("ggplot2")
library("dplyr")
library("ggthemes")
library("knitr")

# this loads all function files in the code/functions directory
function_paths <- list.files("code/functions", full.names = TRUE)
purrr::walk(function_paths, source)
```

```{r load-vcf-data}
# load in, tidy, and stack all of the VCF files in the target directory
# these are the output of the bash pipeline
stacked_vcfs <- parse_tidy_and_stack_vcfs(vcf_dir_path = params$vcf_dir_path)

# load in the gff file with genome annotations for SARS-CoV-2
gff <- read_gff(gff_file_path = params$gff_file_path)

# pull out just the named genes from the annotation file
gene_table <- extract_genes_from_gff(annotation_object = gff)

# combine the stacked vcf table with the gene names and the metadata from
# the sra runtable file
vcf_with_metadata <-
  add_genes_metadata_to_vcfstack(sra_runtable_path = params$sra_runtable_path,
                                 stacked_vcf = stacked_vcfs,
                                 cleaned_genes_table = gene_table)
```

# Figures
```{r barplot-SNP-gene-distribution, echo=TRUE, warning=FALSE, message=FALSE, fig.width=10, fig.height=8}
# Group by gene and summarize SNP counts
gene_snp_summary <- vcf_with_metadata %>%
  group_by(gene) %>%  # Update this if your gene column has a different name
  summarize(total_snps = n()) %>%
  filter(!is.na(gene))

# Create the bar plot
ggplot(gene_snp_summary, aes(x = reorder(gene, -total_snps), y = total_snps,
                             fill = gene)) +
  geom_bar(stat = "identity", alpha = 0.8) +
  labs(
    title = "SNP Counts Across Different Genes",
    x = "Gene",
    y = "SNP Count",
    fill = "Gene"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"  # Hide legend for simplicity
  )
```
**Figure 1**:Figure: Bar plot showing the number of single nucleotide polymorphisms (SNPs) identified across different genes of SARS-CoV-2. The genes are labeled on the x-axis, and the y-axis indicates the count of SNPs. This figure highlights which genes exhibit the highest mutation frequency, with the S gene having the largest number of SNPs, suggesting greater genetic variability in this region. Such information is crucial for understanding the genetic diversity and evolution of the virus in wastewater samples



```{r figure-1,normalized-sequence-coverage, echo=TRUE, warning=FALSE, message=FALSE}
# Convert Collection_Date to Date format
vcf_with_metadata$Collection_Date <- as.Date(vcf_with_metadata$Collection_Date,
                                             format = "%m/%d/%y")
# Normalize Sequencing Coverage by Population Size and create the plot
normalized_plot <- vcf_with_metadata %>%
  mutate(Bases_per_person = Bases / ww_population) %>%
  ggplot(aes(x = Collection_Date,
             y = Bases_per_person,
             color = geo_loc_name)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Normalized Sequencing Coverage Over Time by Region",
    x = "Collection Date",
    y = "Sequencing Coverage per Person",
    color = "Region"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display the plot
print(normalized_plot)
```

**Figure 2**:Temporal Trends in Normalized Sequencing Coverage Over Time in Pennsylvania
The plot shows normalized sequencing coverage (SARS-CoV-2 RNA levels per person) over time for wastewater samples collected in Pennsylvania. Peaks in sequencing coverage may reflect variations in viral prevalence, sampling methods, or population size adjustments. The data are normalized to account for differences in population size represented by each sample.


```{r population-vs-rna-detection, echo=TRUE, warning=FALSE, message=FALSE}
# Load the data using params
data <- read.csv(params$sra_runtable_path)

# Ensure relevant columns are numeric
data$ww_population <- as.numeric(data$ww_population)
data$Bases <- as.numeric(data$Bases)

# Remove rows with missing or invalid data
filtered_data <- data %>%
  filter(!is.na(ww_population), !is.na(Bases))

# Create the scatter plot
scatter_plot <- ggplot(filtered_data, aes(x = ww_population, y = Bases)) +
  geom_point(alpha = 0.7, color = "blue") +
  labs(
    title = "Relationship Between Population Size and RNA Detection",
    x = "Population Size",
    y = "RNA Detection (Bases)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )

# Display the plot
print(scatter_plot)
```
**Figure 3**: Relationship between population size and rna detection

```{r Population-size-AVGspotlens, echo=FALSE}
ggplot(data, aes(x = ww_population, y = AvgSpotLen)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  labs(
      title = "Relationship Between Population Size and AvgSpotLen",
      x = "Population Size",
      y = "Average Spot Length (AvgSpotLen)") +
  theme_minimal()
```
**Figure 4**: Scatter plot showing the relationship between population size and average spot length of sequencing reads. Each blue point represents a sample, and the red regression line indicates the overall trend. The figure suggests a slight negative correlation, implying that as population size increases, the average spot length may decrease slightly. This information helps assess how population size could impact the quality of RNA sequencing in wastewater samples.

```{r boxplot-composite-grab-table, echo=FALSE}
# Load the dataset using the sra_runtable_path parameter
sra_runtable_path <- "data/00_sra_runtable/SraRunTable.csv"
data <- read.csv(sra_runtable_path)

# Plot 3: Distribution of Sampling Methods
ggplot(data, aes(x = ww_sample_type)) +
  geom_bar(fill = "steelblue") +
  labs(
    title = "Distribution of Sampling Methods",
    x = "Sample Type",
    y = "Count"
  ) +
  theme_minimal()
```

# Tables

```{r summary-table-single-chunk, echo=FALSE}
# Summarize sequencing coverage by sampling method and create kable table
summary_table <- data %>%
  group_by(ww_sample_matrix, ww_sample_type) %>%
  summarize(
         Mean_Coverage = mean(Bases, na.rm = TRUE),
         Median_Coverage = median(Bases, na.rm = TRUE),
         Min_Coverage = min(Bases, na.rm = TRUE),
         Max_Coverage = max(Bases, na.rm = TRUE),
         Sample_Count = n(),
        .groups = "drop")
# Create and display the summary table using kable
table_output <- summary_table %>%
  kable(
    col.names = c("Sample Matrix", "Sample Type", "Mean Coverage",
                  "Median Coverage", "Min Coverage", "Max Coverage",
                  "Sample Count"),
    caption = "Summary Statistics of Normalized Sequencing Coverage
    by Sampling Method"
  )
print(table_output)
```





**Table 1**: Gene names, locations, and lengths in the SARS-CoV-2 genome. Higher SNP counts in the S and N genes may be related to the larger size of these genes.

# Sources Cited
