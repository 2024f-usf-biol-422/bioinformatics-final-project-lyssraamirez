---
title: 'Analyzing SARS-CoV-2 in Pennsylvania Wastewater Samples: SNP Distribution, Temporal Trends, and Correlation with Population'
author: "Alyssa Ramirez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
csl: bioinformatics.csl
bibliography: references.bib
params:
  gff_file_path: "data/metadata/sars_refgenome_annotation.gff"
  vcf_dir_path: "data/11_vcf_output_for_R"
  sra_runtable_path: "data/00_sra_runtable/SraRunTable.csv"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE)
```

# Background and Overview

The primary objective of this analysis was to explore SARS-CoV-2 prevalence in Pennsylvania wastewater samples. This project focused on understanding the distribution of single nucleotide polymorphisms (SNPs) within the viral genome and how they varied across geographic locations, sampling techniques, and temporal trends. Using publicly available sequencing data and associated metadata, we sought to answer the following research question:

How does the prevalence of SARS-CoV-2 in wastewater samples correlate with population size, sampling methods, and geographic location over time?

To address this question, we employed a bioinformatics workflow that integrated raw VCF files, GFF annotations, and population metadata. The analyses were performed using custom R scripts, including functions provided by the instructor, and the outputs were used to generate informative figures and tables. The results demonstrated clear spatial and temporal patterns in SARS-CoV-2 prevalence and identified genes with significant SNP counts.



# Methods
Custom R functions provided by the instructor were used for key data processing steps:

1.read_gff: Read and parsed the GFF genome annotation file to extract genomic regions of interest.
2.extract_genes_from_gff: Filtered and cleaned the GFF data to produce a gene table containing genomic coordinates and gene names.
3.parse_tidy_and_stack_vcfs: Processed and combined multiple VCF files into a single tidy dataset, adding sample-specific metadata.
4.add_genes_metadata_to_vcfstack: Annotated SNPs with gene information by merging the tidy VCF data with the cleaned gene table and sequencing metadata.

See the set of tutorials on the [vcfR package website](https://knausb.github.io/vcfR_documentation/index.html).

You may also want to use any of a range of different COVID data packages and data sources:

* https://kjhealy.github.io/covdata/
* https://github.com/como-ph/oxcovid19
* https://ropensci.org/blog/2020/10/20/searching-medrxivr-and-biorxiv-preprint-data/
* https://covidtracking.com/data/api
  * `readr::read_csv("https://api.covidtracking.com/v1/states/daily.csv")`

## Subsections are ok too

# Results and Discussion

```{r load-packages-and-functions}
library("vcfR")
library("ggplot2")
library("dplyr")
library("ggthemes")

# this loads all function files in the code/functions directory
function_paths <- list.files("code/functions", full.names = TRUE)
purrr::walk(function_paths, source)
```


```{r load-vcf-data}
# load in, tidy, and stack all of the VCF files in the target directory
# these are the output of the bash pipeline
stacked_vcfs <- parse_tidy_and_stack_vcfs(vcf_dir_path = params$vcf_dir_path)

# load in the gff file with genome annotations for SARS-CoV-2
gff <- read_gff(gff_file_path = params$gff_file_path)

# pull out just the named genes from the annotation file
gene_table <- extract_genes_from_gff(annotation_object = gff)

# combine the stacked vcf table with the gene names and the metadata from
# the sra runtable file
vcf_with_metadata <-
  add_genes_metadata_to_vcfstack(sra_runtable_path = params$sra_runtable_path,
                                 stacked_vcf = stacked_vcfs,
                                 cleaned_genes_table = gene_table)
```

# Figures

```{r figure-1,sequencing-coverage-by-region}
# Load required libraries
library(ggplot2)
library(dplyr)

# Load the data (replace with your dataset's actual path if necessary)
data <- read.csv(params$sra_runtable_path)

# Convert Collection_Date to Date format
data$Collection_Date <- as.Date(data$Collection_Date, format = "%m/%d/%y")

# Normalize Sequencing Coverage by Population Size
data <- data %>%
  mutate(Bases_per_person = Bases / ww_population)

# Create the line plot
ggplot(data, aes(x = Collection_Date, y = Bases_per_person, color = geo_loc_name)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Normalized Sequencing Coverage Over Time by Region",
    x = "Collection Date",
    y = "Sequencing Coverage per Person",
    color = "Region"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

**Figure 1**:Temporal Trends in Normalized Sequencing Coverage Over Time in Pennsylvania
The plot shows normalized sequencing coverage (SARS-CoV-2 RNA levels per person) over time for wastewater samples collected in Pennsylvania. Peaks in sequencing coverage may reflect variations in viral prevalence, sampling methods, or population size adjustments. The data are normalized to account for differences in population size represented by each sample.

```{r figure-2-sampling-methods, echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=6}
library(ggplot2)
library(dplyr)

data <- read.csv(params$sra_runtable_path)
data$Collection_Date <- as.Date(data$Collection_Date, format = "%m/%d/%y")
data <- data %>%
  mutate(Bases_per_person = Bases / ww_population)

p1 <- ggplot(data, aes(x = ww_sample_matrix, y = Bases_per_person)) +
  geom_boxplot(fill = "skyblue", alpha = 0.7) +
  labs(
    title = "Impact of Sampling Matrix on Normalized Sequencing Coverage",
    x = "Sampling Matrix",
    y = "Sequencing Coverage per Person"
  ) +
  theme_minimal()

p2 <- ggplot(data, aes(x = ww_sample_type, y = Bases_per_person)) +
  geom_boxplot(fill = "orange", alpha = 0.7) +
  labs(
    title = "Impact of Sampling Type on Normalized Sequencing Coverage",
    x = "Sampling Type",
    y = "Sequencing Coverage per Person"
  ) +
  theme_minimal()

library(gridExtra)
grid.arrange(p1, p2, ncol = 2)
```
**Figure 2:**Impact of Sampling Methods on Normalized SARS-CoV-2 Sequencing Coverage
The left box plot compares sequencing coverage per person across different sampling matrices (e.g., "post grit removal" vs. "raw wastewater"). The right boxplot compares sequencing coverage per person across sampling types (e.g., "composite" vs. "grab"). Composite samples show higher variability in SARS-CoV-2 detection, likely due to their ability to aggregate data over time, while raw wastewater samples may retain higher RNA integrity. These comparisons highlight the influence of methodological choices on viral prevalence estimates.

```{r figure-3-population-correlation, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)

# Load the data
data <- read.csv(params$sra_runtable_path)

# Convert Collection_Date to Date format
data$Collection_Date <- as.Date(data$Collection_Date, format = "%m/%d/%y")

# Scatter plot with linear regression line
ggplot(data, aes(x = ww_population, y = Bases, color = Collection_Date)) +
  geom_point(alpha = 0.7, size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "blue", linetype = "dashed") +
  labs(
    title = "Correlation Between Population Size and Sequencing Coverage",
    x = "Population Size",
    y = "Sequencing Coverage",
    color = "Collection Date"
  ) +
  theme_minimal()
```

**Figure 3:** Correlation Between Population Size and Sequencing Coverage in Wastewater Samples
The scatter plot illustrates the relationship between population size and sequencing coverage (SARS-CoV-2 RNA levels) in wastewater samples. A linear regression line is included to assess trends and the strength of correlation. Points are colored by collection date to explore temporal changes in the relationship.

# Tables

```{r summary-table, echo=FALSE}
library(dplyr)
library(knitr)

# Load the data
data <- read.csv(params$sra_runtable_path)

# Convert Collection_Date to Date format
data$Collection_Date <- as.Date(data$Collection_Date, format = "%m/%d/%y")

# Normalize Sequencing Coverage by Population Size
data <- data %>%
  mutate(Bases_per_person = Bases / ww_population)

# Summarize sequencing coverage by sampling method
summary_table <- data %>%
  group_by(ww_sample_matrix, ww_sample_type) %>%
  summarize(
    Mean_Coverage = mean(Bases_per_person, na.rm = TRUE),
    Median_Coverage = median(Bases_per_person, na.rm = TRUE),
    Min_Coverage = min(Bases_per_person, na.rm = TRUE),
    Max_Coverage = max(Bases_per_person, na.rm = TRUE),
    Sample_Count = n()
  )

# Display the table
kable(
  summary_table,
  col.names = c(
    "Sample Matrix", "Sample Type", "Mean Coverage", 
    "Median Coverage", "Min Coverage", "Max Coverage", "Sample Count"
  ),
  caption = "Summary Statistics of Normalized Sequencing Coverage by Sampling Method"
)
```

**Table 1**: Gene names, locations, and lengths in the SARS-CoV-2 genome. Higher SNP counts in the S and N genes may be related to the larger size of these genes.

# Sources Cited
