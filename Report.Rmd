---
title: 'Analyzing SARS-CoV-2 in Pennsylvania Wastewater Samples: SNP Distribution, Temporal Trends, and Correlation with Population'
author: "Alyssa Ramirez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
csl: bioinformatics.csl
bibliography: references.bib
params:
  gff_file_path: "data/metadata/sars_refgenome_annotation.gff"
  vcf_dir_path: "data/11_vcf_output_for_R"
  sra_runtable_path: "data/00_sra_runtable/SraRunTable.csv"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE)
```

# Background and Overview
The monitoring and detection of SARS-CoV-2 RNA in water waste have emerged as another tool in aiding the surveillance of COVID-19 in populations. Water Waste surveillance provides non-invasive, cost-effective methods for  insights and trends in the spread in asymptomatic individuals. This approach has been useful in understanding hotspots, trends and other helpful insights that aid public health. Water waste surveillance also shows the evolutionary trends of SARS-CoV-2 strain advancements.
This study utilizes Pennsylvania Waterwaste Surveillance systems (PAWSS) data, a statewide surveillance system that collects waste samples in diverse communities. The dataset includes metadata from Pennsylvania communities. Specifically data such as population sizes, sequencing information, temporal trends and sample collecting methods. PAWSS provides a comprehensive framework to evaluate temporal and spatial trends in SARS-CoV-2 prevalence across urban and rural regions of Pennsylvania.

Multiple factors influence the effectiveness and reliability of SARS-CoV-2 detection in wastewater samples. Specific sampling methods and collection times are crucial, as they can affect the concentration and virality of RNA. For example, composite samples may yield more data compared to grab samples, while collection during its peak viral periods may capture higher RNA levels. On the other hand, size of the population served by a wastewater treatment surveillance system can play a significant role in determining viral RNA detection. Larger populations may induce dilute viral signs due to wastewater volume, whereas smaller populations may achieve statistically significant viral RNA trends.

The primary goal of this study is to evaluate how collection periods, sampling methods, genome evolution and population size impact SARS-CoV-2 RNA detection in wastewater. By using sequencing metadata on population size and time collecting samples, this analysis seeks to uncover trends and identify viral RNA strains in the reliability of the PAWSS. By normalizing sequence coverage and assessing temporal patterns, this study aims to contribute to the public health.




# Methods
Custom R functions provided by the instructor were used for key data processing steps:

1.read_gff: Read and parsed the GFF genome annotation file to extract genomic regions of interest.
2.extract_genes_from_gff: Filtered and cleaned the GFF data to produce a gene table containing genomic coordinates and gene names.
3.parse_tidy_and_stack_vcfs: Processed and combined multiple VCF files into a single tidy dataset, adding sample-specific metadata.
4.add_genes_metadata_to_vcfstack: Annotated SNPs with gene information by merging the tidy VCF data with the cleaned gene table and sequencing metadata.

See the set of tutorials on the [vcfR package website](https://knausb.github.io/vcfR_documentation/index.html).

You may also want to use any of a range of different COVID data packages and data sources:

* https://kjhealy.github.io/covdata/
* https://github.com/como-ph/oxcovid19
* https://ropensci.org/blog/2020/10/20/searching-medrxivr-and-biorxiv-preprint-data/
* https://covidtracking.com/data/api
  * `readr::read_csv("https://api.covidtracking.com/v1/states/daily.csv")`

## Subsections are ok too

# Results and Discussion
In this study, 

```{r load-packages-and-functions}
library("vcfR")
library("ggplot2")
library("dplyr")
library("ggthemes")
library("knitr")

# this loads all function files in the code/functions directory
function_paths <- list.files("code/functions", full.names = TRUE)
purrr::walk(function_paths, source)
```

```{r load-vcf-data}
# load in, tidy, and stack all of the VCF files in the target directory
# these are the output of the bash pipeline
stacked_vcfs <- parse_tidy_and_stack_vcfs(vcf_dir_path = params$vcf_dir_path)

# load in the gff file with genome annotations for SARS-CoV-2
gff <- read_gff(gff_file_path = params$gff_file_path)

# pull out just the named genes from the annotation file
gene_table <- extract_genes_from_gff(annotation_object = gff)

# combine the stacked vcf table with the gene names and the metadata from
# the sra runtable file
vcf_with_metadata <-
  add_genes_metadata_to_vcfstack(sra_runtable_path = params$sra_runtable_path,
                                 stacked_vcf = stacked_vcfs,
                                 cleaned_genes_table = gene_table)
```

# Figures
```{r barplot-SNP-gene-distribution, echo=TRUE, warning=FALSE, message=FALSE, fig.width=10, fig.height=8}
# Group by gene and summarize SNP counts
gene_snp_summary <- vcf_with_metadata %>%
  group_by(gene) %>%  # Update this if your gene column has a different name
  summarize(total_snps = n()) %>%
  filter(!is.na(gene))

# Create the bar plot
snp_plot <- ggplot(gene_snp_summary, aes(x = reorder(gene, -total_snps),
                                         y = total_snps,
                             fill = gene)) +
  geom_bar(stat = "identity", alpha = 0.8) +
  labs(
    title = "SNP Counts Across Different Genes",
    x = "Gene",
    y = "SNP Count",
    fill = "Gene"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"  # Hide legend for simplicity
  )
# Save the plot to a file
ggsave(filename = "snp_counts_across_genes.png", plot = snp_plot, width = 10, height = 8, dpi = 300)

```
**Figure 1**:Figure: Bar plot showing the number of single nucleotide polymorphisms (SNPs) identified across different genes of SARS-CoV-2. The genes are labeled on the x-axis, and the y-axis indicates the count of SNPs. This figure highlights which genes exhibit the highest mutation frequency, with the S gene having the largest number of SNPs, suggesting greater genetic variability in this region. Such information is crucial for understanding the genetic diversity and evolution of the virus in wastewater samples


```{r figure-1,normalized-sequence-coverage, echo=TRUE, warning=FALSE, message=FALSE}
# Convert Collection_Date to Date format
vcf_with_metadata$Collection_Date <- as.Date(vcf_with_metadata$Collection_Date,
                                             format = "%m/%d/%y")

# Normalize Sequencing Coverage by Population Size and create the plot
normalized_plot <- vcf_with_metadata %>%
  mutate(Bases_per_person = Bases / ww_population) %>%
  ggplot(aes(x = Collection_Date,
             y = Bases_per_person,
             color = geo_loc_name)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Normalized Sequencing Coverage Over Time by Region",
    x = "Collection Date",
    y = "Sequencing Coverage per Person",
    color = "Region"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Save the plot to a file
ggsave(filename = "normalized_sequencing_coverage.png", plot = normalized_plot,
       width = 10, height = 8, dpi = 300)
```

**Figure 2**:Temporal Trends in Normalized Sequencing Coverage Over Time in Pennsylvania
The plot shows normalized sequencing coverage (SARS-CoV-2 RNA levels per person) over time for wastewater samples collected in Pennsylvania. Peaks in sequencing coverage may reflect variations in viral prevalence, sampling methods, or population size adjustments. The data are normalized to account for differences in population size represented by each sample.

```{r population-vs-rna-detection, echo=TRUE, warning=FALSE, message=FALSE}
# Load the data using params
data <- read.csv(params$sra_runtable_path)

# Ensure relevant columns are numeric
data$ww_population <- as.numeric(data$ww_population)
data$Bases <- as.numeric(data$Bases)

# Remove rows with missing or invalid data
filtered_data <- data %>%
  filter(!is.na(ww_population), !is.na(Bases))

# Create the scatter plot
scatter_plot <- ggplot(filtered_data, aes(x = ww_population, y = Bases)) +
  geom_point(alpha = 0.7, color = "blue") +
  labs(
    title = "Relationship Between Population Size and RNA Detection",
    x = "Population Size",
    y = "RNA Detection (Bases)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )
# Save the plot to a file
ggsave(filename = "population_vs_rna_detection.png", plot = scatter_plot, width = 10, height = 8, dpi = 300)
```
**Figure 3**: Relationship between population size and rna detection

```{r Population-size-AVGspotlens, echo=FALSE}
# Create the scatter plot with regression line
avg_spotlen_plot <- ggplot(data, aes(x = ww_population, y = AvgSpotLen)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  labs(
       title = "Relationship Between Population Size and AvgSpotLen",
       x = "Population Size",
       y = "Average Spot Length (AvgSpotLen)") +
  theme_minimal()

# Save the plot to a file
ggsave(filename = "population_size_avg_spotlen.png", plot = avg_spotlen_plot,
       width = 10, height = 8, dpi = 300)
```
**Figure 4**: Scatter plot showing the relationship between population size and average spot length of sequencing reads. Each blue point represents a sample, and the red regression line indicates the overall trend. The figure suggests a slight negative correlation, implying that as population size increases, the average spot length may decrease slightly. This information helps assess how population size could impact the quality of RNA sequencing in wastewater samples.

```{r boxplot-composite-grab-table, echo=FALSE}
# Load the dataset using the sra_runtable_path parameter
sra_runtable_path <- "data/00_sra_runtable/SraRunTable.csv"
data <- read.csv(sra_runtable_path)
# Create the bar plot for distribution of sampling methods
sampling_methods_plot <- ggplot(data, aes(x = ww_sample_type)) +
  geom_bar(fill = "steelblue") +
  labs(
    title = "Distribution of Sampling Methods",
    x = "Sample Type",
    y = "Count"
  ) +
  theme_minimal()
# Save the plot to a file
ggsave(filename = "distribution_sampling_methods.png", plot = sampling_methods_plot, width = 10, height = 8, dpi = 300)

```
**Figure 5:** 
```{r genome-bar-graph, echo=FALSE}
# Filter dataset
common_variants <- vcf_with_metadata %>%
  group_by(ref, alt) %>%
  summarize(Count = n(), .groups = 'drop') %>%
  filter(Count > 500)
# Create a bar plot to visualize the reference vs. alternate genome 
ggplot(common_variants, aes(x = ref, y = Count, fill = alt)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  labs(
    title = "Distribution of Common Reference vs. Alternate Genome Variants",
    x = "Reference Genome",
    y = "Count of Variants",
    fill = "Alternate Genome"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10) 
  )
```
#Tables
```{r summary-table-single-chunk, echo=FALSE}
library(gridExtra)

# Summarize sequencing coverage by sampling method
summary_table <- vcf_with_metadata %>%
  group_by(ww_sample_matrix, ww_sample_type) %>%
  summarize(
    Mean_Coverage = mean(Bases, na.rm = TRUE),
    Median_Coverage = median(Bases, na.rm = TRUE),
    Min_Coverage = min(Bases, na.rm = TRUE),
    Max_Coverage = max(Bases, na.rm = TRUE),
    Sample_Count = n(),
    .groups = "drop"
  )

# Create a data frame for table
summary_table_df <- as.data.frame(summary_table)

# Create a table plot using tableGrob
table_plot <- tableGrob(summary_table_df)

# Save the table plot as a PNG file
output_file <- "summary_table_output.png"
ggsave(filename = output_file, plot = table_plot, width = 10,
       height = 8, dpi = 300, device = "png")

```
**Table 1**: Gene names, locations, and lengths in the SARS-CoV-2 genome. Higher SNP counts in the S and N genes may be related to the larger size of these genes.

# Sources Cited
