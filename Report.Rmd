---
title: 'Analyzing SARS-CoV-2 in Pennsylvania Wastewater Samples: SNP Distribution, Temporal Trends, and Correlation with Population'
author: "Alyssa Ramirez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
csl: bioinformatics.csl
bibliography: references.bib
params:
  gff_file_path: "data/metadata/sars_refgenome_annotation.gff"
  vcf_dir_path: "data/11_vcf_output_for_R"
  sra_runtable_path: "data/00_sra_runtable/SraRunTable.csv"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE)
```

# Background and Overview

The primary objective of this analysis was to explore SARS-CoV-2 prevalence in Pennsylvania wastewater samples. This project focused on understanding the distribution of single nucleotide polymorphisms (SNPs) within the viral genome and how they varied across geographic locations, sampling techniques, and temporal trends. Using publicly available sequencing data and associated metadata, we sought to answer the following research question:

How does the prevalence of SARS-CoV-2 in wastewater samples correlate with population size, sampling methods, and geographic location over time?

To address this question, we employed a bioinformatics workflow that integrated raw VCF files, GFF annotations, and population metadata. The analyses were performed using custom R scripts, including functions provided by the instructor, and the outputs were used to generate informative figures and tables. The results demonstrated clear spatial and temporal patterns in SARS-CoV-2 prevalence and identified genes with significant SNP counts.



# Methods
Custom R functions provided by the instructor were used for key data processing steps:

1.read_gff: Read and parsed the GFF genome annotation file to extract genomic regions of interest.
2.extract_genes_from_gff: Filtered and cleaned the GFF data to produce a gene table containing genomic coordinates and gene names.
3.parse_tidy_and_stack_vcfs: Processed and combined multiple VCF files into a single tidy dataset, adding sample-specific metadata.
4.add_genes_metadata_to_vcfstack: Annotated SNPs with gene information by merging the tidy VCF data with the cleaned gene table and sequencing metadata.

See the set of tutorials on the [vcfR package website](https://knausb.github.io/vcfR_documentation/index.html).

You may also want to use any of a range of different COVID data packages and data sources:

* https://kjhealy.github.io/covdata/
* https://github.com/como-ph/oxcovid19
* https://ropensci.org/blog/2020/10/20/searching-medrxivr-and-biorxiv-preprint-data/
* https://covidtracking.com/data/api
  * `readr::read_csv("https://api.covidtracking.com/v1/states/daily.csv")`

## Subsections are ok too

# Results and Discussion

```{r load-packages-and-functions}
library("vcfR")
library("ggplot2")
library("dplyr")
library("ggthemes")

# this loads all function files in the code/functions directory
function_paths <- list.files("code/functions", full.names = TRUE)
purrr::walk(function_paths, source)
```


```{r load-vcf-data}
# load in, tidy, and stack all of the VCF files in the target directory
# these are the output of the bash pipeline
stacked_vcfs <- parse_tidy_and_stack_vcfs(vcf_dir_path = params$vcf_dir_path)

# load in the gff file with genome annotations for SARS-CoV-2
gff <- read_gff(gff_file_path = params$gff_file_path)

# pull out just the named genes from the annotation file
gene_table <- extract_genes_from_gff(annotation_object = gff)

# combine the stacked vcf table with the gene names and the metadata from
# the sra runtable file
vcf_with_metadata <-
  add_genes_metadata_to_vcfstack(sra_runtable_path = params$sra_runtable_path,
                                 stacked_vcf = stacked_vcfs,
                                 cleaned_genes_table = gene_table)
```

# Figures
```{r barplot-gene-distribution, echo=TRUE, warning=FALSE, message=FALSE, fig.width=10, fig.height=8}
# Group by gene and summarize SNP counts
gene_snp_summary <- vcf_with_metadata %>%
  group_by(gene) %>%  # Update this if your gene column has a different name
  summarize(total_snps = n()) %>%
  filter(!is.na(gene))

# Create the bar plot
ggplot(gene_snp_summary, aes(x = reorder(gene, -total_snps), y = total_snps,
                             fill = gene)) +
  geom_bar(stat = "identity", alpha = 0.8) +
  labs(
    title = "SNP Counts Across Different Genes",
    x = "Gene",
    y = "SNP Count",
    fill = "Gene"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"  # Hide legend for simplicity
  )
```
**Figure 1**:


```{r figure-1, echo=TRUE, warning=FALSE, message=FALSE}
# Convert Collection_Date to Date format
vcf_with_metadata$Collection_Date <- as.Date(vcf_with_metadata$Collection_Date, format = "%m/%d/%y")

# Normalize Sequencing Coverage by Population Size and create the plot
normalized_plot <- data %>%
  mutate(Bases_per_person = Bases / ww_population) %>%
  ggplot(aes(x = Collection_Date, 
             y = Bases_per_person, 
             color = geo_loc_name)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Normalized Sequencing Coverage Over Time by Region",
    x = "Collection Date",
    y = "Sequencing Coverage per Person",
    color = "Region"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display the plot
print(normalized_plot)

# Save the plot as a PNG file
ggsave("sequencing_coverage_plot.png", plot = normalized_plot, width = 10, height = 6, dpi = 300)

```

**Figure 2**:Temporal Trends in Normalized Sequencing Coverage Over Time in Pennsylvania
The plot shows normalized sequencing coverage (SARS-CoV-2 RNA levels per person) over time for wastewater samples collected in Pennsylvania. Peaks in sequencing coverage may reflect variations in viral prevalence, sampling methods, or population size adjustments. The data are normalized to account for differences in population size represented by each sample.


```{r population-vs-rna-detection, echo=TRUE, warning=FALSE, message=FALSE}
# Load the data using params
data <- read.csv(params$sra_runtable_path)

# Ensure relevant columns are numeric
data$ww_population <- as.numeric(data$ww_population)
data$Bases <- as.numeric(data$Bases)

# Remove rows with missing or invalid data
filtered_data <- data %>%
  filter(!is.na(ww_population), !is.na(Bases))

# Create the scatter plot
scatter_plot <- ggplot(filtered_data, aes(x = ww_population, y = Bases)) +
  geom_point(alpha = 0.7, color = "blue") +
  labs(
    title = "Relationship Between Population Size and RNA Detection",
    x = "Population Size",
    y = "RNA Detection (Bases)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )

# Display the plot
print(scatter_plot)

# Save the plot as a PNG file
ggsave("population_vs_rna_detection.png", plot = scatter_plot, width = 8, height = 6, dpi = 300)
```
**Figure 3**: Relationship between population size and rna detection

# Tables

```{r summary-table, echo=FALSE}
# Load the data
data <- read.csv(params$sra_runtable_path)

# Convert Collection_Date to Date format
data$Collection_Date <- as.Date(data$Collection_Date, format = "%m/%d/%y")

# Normalize Sequencing Coverage by Population Size
data <- data %>%
  mutate(Bases_per_person = Bases / ww_population)

# Summarize sequencing coverage by sampling method
summary_table <- data %>%
  group_by(ww_sample_matrix, ww_sample_type) %>%
  summarize(
    Mean_Coverage = mean(Bases_per_person, na.rm = TRUE),
    Median_Coverage = median(Bases_per_person, na.rm = TRUE),
    Min_Coverage = min(Bases_per_person, na.rm = TRUE),
    Max_Coverage = max(Bases_per_person, na.rm = TRUE),
    Sample_Count = n()
  )

# Create a kable table
table_output <- kable(
  summary_table,
  col.names = c("Sample Matrix", "Sample Type", "Mean Coverage", 
                "Median Coverage", "Min Coverage", "Max Coverage", "Sample Count"),
  caption = "Summary Statistics of Normalized Sequencing Coverage by Sampling Method"
)

# Print the table
print(table_output)

# Save the table as a PNG file
png("summary_table.png", width = 1200, height = 800)
grid.table(summary_table)
dev.off()
```

**Table 1**: Gene names, locations, and lengths in the SARS-CoV-2 genome. Higher SNP counts in the S and N genes may be related to the larger size of these genes.

# Sources Cited
